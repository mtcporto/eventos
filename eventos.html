<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agenda de Eventos - JP</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome para ícones -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #3498db;
      --secondary: #2ecc71;
      --dark: #34495e;
      --light: #f5f5f5;
      --danger: #e74c3c;
      --success: #27ae60;
      --warning: #f39c12;
      --info: #9b59b6;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f9f9f9;
      margin: 0;
      padding: 0;
    }
    
    .header {
      background: linear-gradient(135deg, var(--primary), var(--info));
      color: white;
      padding: 20px 0;
      text-align: center;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      margin: 0;
      font-size: 2.5rem;
      font-weight: 600;
    }
    
    .header p {
      margin: 5px 0 0;
      font-size: 1.1rem;
      opacity: 0.9;
    }
    
    .filters {
      background-color: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .section-title {
      font-size: 1.5rem;
      margin-bottom: 15px;
      font-weight: 600;
      color: var(--dark);
      padding-bottom: 8px;
      border-bottom: 2px solid var(--light);
    }
    
    .card {
      transition: transform 0.3s, box-shadow 0.3s;
      margin-bottom: 20px;
      border: none;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .card-img-top {
      height: 180px;
      object-fit: cover;
      background-color: #eee;
    }
    
    .card-img-loading-placeholder {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 180px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f0f0f0;
      z-index: 1;
    }
    
    .card-img-top-container {
      position: relative;
      height: 180px;
      overflow: hidden;
    }
    
    .img-error {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      color: #999;
      font-size: 2rem;
    }
    
    .past-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: rgba(153, 153, 153, 0.8);
      color: white;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      z-index: 2;
    }
    
    .card-img-placeholder {
      height: 180px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f0f0f0;
      color: #888;
      font-size: 24px;
    }
    
    .card-body {
      padding: 15px;
    }
    
    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--dark);
      line-height: 1.3;
    }
    
    .card-text {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 5px;
    }
    
    .card-text i {
      width: 16px;
      margin-right: 5px;
      color: var(--primary);
    }
    
    .badge {
      padding: 5px 8px;
      margin-bottom: 10px;
      display: inline-block;
      font-weight: 500;
      font-size: 0.75rem;
    }
    
    .badge-today {
      background-color: var(--danger);
      color: white;
    }
    
    .badge-tomorrow {
      background-color: var(--warning);
      color: white;
    }
    
    .badge-week {
      background-color: var(--success);
      color: white;
    }
    
    .badge-upcoming {
      background-color: var(--info);
      color: white;
    }
    
    .badge-past {
      background-color: #999;
      color: white;
    }
    
    .fonte {
      margin-bottom: 10px;
    }
    
    .fonte .badge {
      background-color: #f8f9fa;
      color: #444;
      border: 1px solid #ddd;
    }
    
    .card-link {
      text-decoration: none;
      color: inherit;
      display: block;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      background-color: white;
      border-radius: 8px;
      margin-bottom: 30px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .empty-state i {
      font-size: 3rem;
      color: #ccc;
      margin-bottom: 15px;
    }
    
    .empty-state h3 {
      font-size: 1.5rem;
      color: #555;
      margin-bottom: 10px;
    }
    
    .empty-state p {
      color: #777;
      margin-bottom: 15px;
    }
    
    .tabs {
      display: flex;
      margin-bottom: 20px;
      background-color: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .tab {
      flex: 1;
      text-align: center;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
      font-weight: 500;
    }
    
    .tab.active {
      border-bottom-color: var(--primary);
      color: var(--primary);
      background-color: rgba(52, 152, 219, 0.05);
    }
    
    .tab:hover:not(.active) {
      background-color: #f8f9fa;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 40px 20px;
    }
    
    .spinner-border {
      width: 3rem;
      height: 3rem;
      color: var(--primary);
    }
    
    .footer {
      background-color: var(--dark);
      color: white;
      text-align: center;
      padding: 20px 0;
      margin-top: 40px;
    }
    
    .footer p {
      margin-bottom: 10px;
      opacity: 0.8;
    }
    
    .footer-actions {
      margin-bottom: 15px;
    }
    
    .footer a {
      color: white;
      text-decoration: none;
      opacity: 0.8;
      transition: opacity 0.3s;
    }
    
    .footer a:hover {
      opacity: 1;
    }
    
    @media (max-width: 768px) {
      .header h1 {
        font-size: 2rem;
      }
      
      .header p {
        font-size: 1rem;
      }
      
      .section-title {
        font-size: 1.3rem;
      }
    }
  </style>
</head>
<body>
  <!-- Cabeçalho -->
  <header class="header">
    <div class="container">
      <h1>Agenda de Eventos</h1>
      <p>Tudo o que acontece em João Pessoa</p>
    </div>
  </header>
  
  <div class="container">
    <!-- Tabs de navegação -->
    <div class="tabs">
      <div class="tab active" onclick="setActiveTab(this, 'upcoming')">Próximos Eventos</div>
      <div class="tab" onclick="setActiveTab(this, 'today')">Hoje</div>
      <div class="tab" onclick="setActiveTab(this, 'weekend')">Fim de Semana</div>
      <div class="tab" onclick="setActiveTab(this, 'past')">Eventos Passados</div>
    </div>
    
    <!-- Filtros -->
    <div class="filters">
      <div class="row align-items-center">
        <div class="col-md-4 mb-3 mb-md-0">
          <label for="filterLocal" class="form-label">Filtrar por Local</label>
          <select class="form-select" id="filterLocal" onchange="aplicarFiltros()">
            <option value="">Todos os locais</option>
          </select>
        </div>
        <div class="col-md-4 mb-3 mb-md-0">
          <label for="filterFonte" class="form-label">Filtrar por Fonte</label>
          <select class="form-select" id="filterFonte" onchange="aplicarFiltros()">
            <option value="">Todas as fontes</option>
          </select>
        </div>
        <div class="col-md-4 mb-3 mb-md-0">
          <label for="searchQuery" class="form-label">Buscar</label>
          <input type="text" class="form-control" id="searchQuery" placeholder="Digite algo..." oninput="aplicarFiltros()">
        </div>
      </div>
    </div>
    
    <!-- Estado de carregamento -->
    <div id="loading" class="loading">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Carregando...</span>
      </div>
      <p class="mt-3">Buscando eventos...</p>
    </div>
    
    <!-- Container para eventos de hoje -->
    <div id="today-container" class="event-container" style="display: none;">
      <h2 class="section-title">Eventos de Hoje</h2>
      <div id="today-events" class="row"></div>
    </div>
    
    <!-- Container para eventos de amanhã -->
    <div id="tomorrow-container" class="event-container" style="display: none;">
      <h2 class="section-title">Eventos de Amanhã</h2>
      <div id="tomorrow-events" class="row"></div>
    </div>
    
    <!-- Container para eventos do final de semana -->
    <div id="weekend-container" class="event-container" style="display: none;">
      <h2 class="section-title">Eventos do Final de Semana</h2>
      <div id="weekend-events" class="row"></div>
    </div>
    
    <!-- Container para próximos eventos -->
    <div id="upcoming-container" class="event-container">
      <h2 class="section-title">Próximos Eventos</h2>
      <div id="upcoming-events" class="row"></div>
    </div>
    
    <!-- Container para eventos passados -->
    <div id="past-container" class="event-container" style="display: none;">
      <h2 class="section-title">Eventos Passados</h2>
      <div id="past-events" class="row"></div>
    </div>
    
    <!-- Mensagem de nenhum evento encontrado -->
    <div id="no-events" class="empty-state" style="display: none;">
      <i class="fas fa-calendar-times"></i>
      <h3>Nenhum evento encontrado</h3>
      <p>Tente mudar os filtros ou volte mais tarde para conferir novidades.</p>
      <button class="btn btn-primary" onclick="fetchEventos(true)">
        <i class="fas fa-sync-alt"></i> Atualizar
      </button>
    </div>
  </div>
  
  <!-- Fim do conteúdo principal -->
  
  <!-- Modal para adicionar/editar evento -->
  <div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="eventModalLabel">Novo Evento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-danger" id="formError" style="display: none;"></div>
          <form id="eventForm" class="needs-validation" novalidate>
            <input type="hidden" id="eventId">
            <input type="hidden" id="imageUrl">
            
            <div class="row mb-3">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="eventTitle" class="form-label">Título *</label>
                  <input type="text" class="form-control" id="eventTitle" required>
                </div>
                
                <div class="mb-3">
                  <label for="eventDate" class="form-label">Data e Hora *</label>
                  <input type="text" class="form-control" id="eventDate" placeholder="DD/MM/AAAA HH:MM" required>
                  <small class="form-text text-muted">Formato: DD/MM/AAAA HH:MM</small>
                </div>
                
                <div class="mb-3">
                  <label for="eventPlace" class="form-label">Cidade *</label>
                  <input type="text" class="form-control" id="eventPlace" required>
                </div>
                
                <div class="mb-3">
                  <label for="eventLocation" class="form-label">Local *</label>
                  <input type="text" class="form-control" id="eventLocation" required>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="eventImage" class="form-label">Imagem</label>
                  <div class="text-center border p-3 mb-2">
                    <img id="imagePreview" src="" alt="Preview da imagem" style="max-width: 100%; max-height: 200px; display: none;">
                    <div id="noImageIcon" class="d-flex justify-content-center align-items-center bg-light" style="height: 200px;">
                      <i class="fas fa-image text-muted" style="font-size: 3rem;"></i>
                    </div>
                  </div>
                  <div class="d-flex">
                    <input type="file" class="form-control" id="eventImage" accept="image/*" style="display: none;">
                    <button type="button" class="btn btn-outline-primary flex-grow-1 me-2" id="uploadImageBtn">
                      <i class="fas fa-upload"></i> Selecionar imagem
                    </button>
                    <button type="button" class="btn btn-outline-danger" id="removeImageBtn" style="display: none;">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                  <small class="form-text text-muted">Tamanho máximo: 3MB</small>
                </div>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="eventSource" class="form-label">Fonte *</label>
              <input type="text" class="form-control" id="eventSource" required>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="eventPrice" class="form-label">Preço</label>
                  <input type="text" class="form-control" id="eventPrice" placeholder="Gratuito ou valor">
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="eventType" class="form-label">Tipo</label>
                  <select class="form-select" id="eventType">
                    <option value="">Selecione</option>
                    <option value="show">Show</option>
                    <option value="teatro">Teatro</option>
                    <option value="exposicao">Exposição</option>
                    <option value="workshop">Workshop</option>
                    <option value="outro">Outro</option>
                  </select>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="saveEventBtn">Salvar</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Rodapé -->
  <footer class="footer">
    <div class="container">
      <p>Mini Agente de Eventos &copy; <span id="current-year">2025</span></p>
      <div class="footer-actions">
        <button id="clearCacheBtn" class="btn btn-sm btn-outline-light me-2">
          <i class="fas fa-trash-alt"></i> Limpar Cache
        </button>
        <button id="refreshBtn" class="btn btn-sm btn-outline-light">
          <i class="fas fa-sync-alt"></i> Atualizar Dados
        </button>
      </div>
      <button id="btnAddEvent" class="btn btn-primary position-fixed" style="bottom: 20px; right: 20px; border-radius: 50%; width: 60px; height: 60px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
        <i class="fas fa-plus"></i>
      </button>
    </div>
  </footer>
  
  <!-- Bootstrap e outros scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js" crossorigin="anonymous"></script>

  <!-- Função setActiveTab definida globalmente para ser acessível aos manipuladores de eventos onclick -->
  <script>
    // Função para alternar entre abas - movida para escopo global
    function setActiveTab(element, tabName) {
      // Remove active class from all tabs
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      
      // Add active class to clicked tab
      element.classList.add('active');
      
      // Hide all containers
      document.querySelectorAll('.event-container').forEach(container => {
        container.style.display = 'none';
      });
      
      // Show the selected container
      document.getElementById(tabName + '-container').style.display = 'block';
      
      // Apply filtering based on the selected tab
      if (window.aplicarFiltros) {
        window.aplicarFiltros(tabName);
      }
    }
  </script>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Atualizar o ano atual no rodapé
      document.getElementById('current-year').textContent = new Date().getFullYear();
      
      // Inicializar variáveis
      let eventos = [];
      let currentFilter = 'todos';
      let imageCache = new Map(); // Cache para armazenar imagens já carregadas
      const CACHE_DURATION = 30 * 60 * 1000; // 30 minutos em milissegundos
      let currentTab = 'upcoming'; // Tab ativa por padrão
      
      // Obter eventos do servidor com o endpoint correto
      window.fetchEventos = function(forceRefresh = false) {
        // Mostrar o estado de carregamento
        document.getElementById('loading').style.display = 'block';
        
        // Verificar se há dados em cache e se não é uma atualização forçada
        const cachedData = localStorage.getItem('eventos_cache');
        const cachedTimestamp = localStorage.getItem('eventos_cache_timestamp');
        const currentTime = new Date().getTime();
        
        if (!forceRefresh && cachedData && cachedTimestamp && 
            (currentTime - parseInt(cachedTimestamp) < CACHE_DURATION)) {
          // Usar dados do cache
          console.log("Usando dados em cache (menos de 30 minutos)");
          eventos = JSON.parse(cachedData);
          document.getElementById('loading').style.display = 'none';
          processEvents(eventos);
          return;
        }
        
        // Se chegou aqui, buscar dados novos
        // Corrigido o endpoint para o correto na API externa
        fetch('https://mtcporto.pythonanywhere.com/eventos/default/eventos')
          .then(response => {
            if (!response.ok) {
              throw new Error('Servidor retornou erro ' + response.status);
            }
            return response.json();
          })
          .then(data => {
            // A API retorna um objeto com propriedade "eventos"
            eventos = data.eventos || [];
            
            // Salvar dados no cache
            localStorage.setItem('eventos_cache', JSON.stringify(eventos));
            localStorage.setItem('eventos_cache_timestamp', currentTime.toString());
            
            if (eventos.length === 0) {
              document.getElementById('no-events').style.display = 'block';
            } else {
              document.getElementById('no-events').style.display = 'none';
              processEvents(eventos);
            }
            document.getElementById('loading').style.display = 'none';
          })
          .catch(error => {
            console.error('Erro ao obter eventos:', error);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('no-events').style.display = 'block';
            
            // Não mostrar dados de exemplo, apenas exibir mensagem de erro
            const container = document.querySelector('.container');
            const tabs = document.querySelector('.tabs');
            
            // Verificar se já existe um alerta antes de criar outro
            const existingAlert = document.querySelector('.alert-warning');
            if (!existingAlert && container && tabs) {
              const alertDiv = document.createElement('div');
              alertDiv.className = 'alert alert-warning alert-dismissible fade show';
              alertDiv.innerHTML = `
                <strong>Erro ao conectar com o servidor!</strong> Não foi possível obter os eventos.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              `;
              container.insertBefore(alertDiv, tabs);
            }
          });
      }
      
      // Processar eventos e preencher os filtros dropdown
      function processEvents(events) {
        // Coletar todos os locais e fontes únicos
        const locais = new Set();
        const fontes = new Set();
        
        events.forEach(evento => {
          if (evento.local) locais.add(evento.local);
          if (evento.fonte) fontes.add(evento.fonte);
        });
        
        // Preencher o dropdown de locais
        const localSelect = document.getElementById('filterLocal');
        localSelect.innerHTML = '<option value="">Todos os locais</option>';
        
        Array.from(locais).sort().forEach(local => {
          const option = document.createElement('option');
          option.value = local;
          option.textContent = local;
          localSelect.appendChild(option);
        });
        
        // Preencher o dropdown de fontes
        const fonteSelect = document.getElementById('filterFonte');
        fonteSelect.innerHTML = '<option value="">Todas as fontes</option>';
        
        Array.from(fontes).sort().forEach(fonte => {
          const option = document.createElement('option');
          option.value = fonte;
          option.textContent = fonte;
          fonteSelect.appendChild(option);
        });
        
        // Aplicar filtros iniciais
        aplicarFiltros();
        
        // Exibir também na listagem antiga por compatibilidade
        displayEventos(events);
      }
      
      // Função para pré-carregar imagens
      function preloadImage(url) {
        return new Promise((resolve, reject) => {
          // Se a imagem já está em cache, retornar imediatamente
          if (imageCache.has(url)) {
            resolve(url);
            return;
          }
          
          const img = new Image();
          img.onload = () => {
            // Adicionar ao cache e resolver
            imageCache.set(url, true);
            resolve(url);
          };
          img.onerror = () => {
            // Em caso de erro, resolver com null
            reject(null);
          };
          img.src = url;
        });
      }
      
      // Função para aplicar filtros aos eventos
      window.aplicarFiltros = function(tab) {
        // Se uma tab específica foi passada, atualizar a tab atual
        if (tab) {
          currentTab = tab;
        }
        
        // Obter valores dos filtros
        const localFilter = document.getElementById('filterLocal').value;
        const fonteFilter = document.getElementById('filterFonte').value;
        const searchQuery = document.getElementById('searchQuery').value.toLowerCase();
        
        // Aplicar filtros
        let filteredEvents = eventos.filter(evento => {
          // Filtro de pesquisa
          const matchesSearch = !searchQuery || 
            evento.oque.toLowerCase().includes(searchQuery) || 
            (evento.local && evento.local.toLowerCase().includes(searchQuery)) || 
            (evento.onde && evento.onde.toLowerCase().includes(searchQuery));
            
          // Filtro de local
          const matchesLocal = !localFilter || evento.local === localFilter;
          
          // Filtro de fonte
          const matchesFonte = !fonteFilter || evento.fonte === fonteFilter;
          
          return matchesSearch && matchesLocal && matchesFonte;
        });
        
        // Limpar os containers de eventos
        document.getElementById('today-events').innerHTML = '';
        document.getElementById('tomorrow-events').innerHTML = '';
        document.getElementById('weekend-events').innerHTML = '';
        document.getElementById('upcoming-events').innerHTML = '';
        document.getElementById('past-events').innerHTML = '';
        
        // Mostrar mensagem se não houver eventos
        if (filteredEvents.length === 0) {
          document.getElementById('no-events').style.display = 'block';
          return;
        }
        
        // Esconder mensagem de nenhum evento encontrado
        document.getElementById('no-events').style.display = 'none';
        
        // Dados para classificar eventos
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        const dayAfterTomorrow = new Date(today);
        dayAfterTomorrow.setDate(dayAfterTomorrow.getDate() + 2);
        
        const nextMonday = new Date(today);
        nextMonday.setDate(nextMonday.getDate() + (8 - nextMonday.getDay()) % 7);
        
        // Classificar eventos por categorias de data
        const todayEvents = [];
        const tomorrowEvents = [];
        const weekendEvents = [];
        const upcomingEvents = [];
        const pastEvents = [];
        
        filteredEvents.forEach(evento => {
          const eventDate = parseDateString(evento.quando);
          const eventDateOnly = new Date(eventDate);
          eventDateOnly.setHours(0, 0, 0, 0);
          
          // Verificar se é hoje
          if (eventDateOnly.getTime() === today.getTime()) {
            todayEvents.push(evento);
          }
          
          // Verificar se é amanhã
          if (eventDateOnly.getTime() === tomorrow.getTime()) {
            tomorrowEvents.push(evento);
          }
          
          // Verificar se é fim de semana (próximo sábado e domingo)
          const dayOfWeek = eventDateOnly.getDay(); // 0 (domingo) a 6 (sábado)
          
          if ((dayOfWeek === 0 || dayOfWeek === 6) && // É sábado ou domingo
              eventDateOnly >= today && // É hoje ou futuro
              eventDateOnly < nextMonday) { // É antes da próxima segunda
            weekendEvents.push(evento);
          }
          
          // Verificar se é próximo (futuro)
          if (eventDateOnly >= today) {
            upcomingEvents.push(evento);
          } else {
            // É passado
            pastEvents.push(evento);
          }
        });
        
        // Ordenar eventos por data
        const sortByDate = (a, b) => {
          const dataA = parseDateString(a.quando);
          const dataB = parseDateString(b.quando);
          return dataA - dataB;
        };
        
        todayEvents.sort(sortByDate);
        tomorrowEvents.sort(sortByDate);
        weekendEvents.sort(sortByDate);
        upcomingEvents.sort(sortByDate);
        // Eventos passados ordenados do mais recente para o mais antigo
        pastEvents.sort((a, b) => {
          const dataA = parseDateString(a.quando);
          const dataB = parseDateString(b.quando);
          return dataB - dataA;
        });
        
        // Exibir contadores nos títulos das abas
        document.querySelector('.tab[onclick*="today"]').textContent = `Hoje ${todayEvents.length ? '(' + todayEvents.length + ')' : ''}`;
        document.querySelector('.tab[onclick*="weekend"]').textContent = `Fim de Semana ${weekendEvents.length ? '(' + weekendEvents.length + ')' : ''}`;
        document.querySelector('.tab[onclick*="upcoming"]').textContent = `Próximos Eventos ${upcomingEvents.length ? '(' + upcomingEvents.length + ')' : ''}`;
        document.querySelector('.tab[onclick*="past"]').textContent = `Eventos Passados ${pastEvents.length ? '(' + pastEvents.length + ')' : ''}`;
        
        // Mostrar eventos nas respectivas seções
        createEventCards(todayEvents, 'today-events');
        createEventCards(tomorrowEvents, 'tomorrow-events');
        createEventCards(weekendEvents, 'weekend-events');
        createEventCards(upcomingEvents, 'upcoming-events');
        createEventCards(pastEvents, 'past-events');
        
        // Se não houver eventos em uma categoria específica, mostrar mensagem
        if (currentTab === 'today' && todayEvents.length === 0) {
          document.getElementById('no-events').style.display = 'block';
        } else if (currentTab === 'weekend' && weekendEvents.length === 0) {
          document.getElementById('no-events').style.display = 'block';
        } else if (currentTab === 'upcoming' && upcomingEvents.length === 0) {
          document.getElementById('no-events').style.display = 'block';
        } else if (currentTab === 'past' && pastEvents.length === 0) {
          document.getElementById('no-events').style.display = 'block';
        }
      }
      
      // Função para criar cards de eventos para uma seção
      function createEventCards(eventos, containerId) {
        const container = document.getElementById(containerId);
        
        eventos.forEach(evento => {
          const col = document.createElement('div');
          col.className = 'col-md-4 mb-4';
          
          // Formatar data para exibição
          const eventDate = parseDateString(evento.quando);
          const formattedDate = new Intl.DateTimeFormat('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          }).format(eventDate);
          
          // Determinar se é um evento passado
          const isPast = eventDate < new Date();
          
          // Definir classe com base no status do evento
          let statusClass = isPast ? 'past-event' : 'upcoming-event';
          
          // Construir a URL da imagem
          const imageUrl = `https://mtcporto.pythonanywhere.com/eventos/default/imagem/${evento.imagem}`;
          
          const card = document.createElement('div');
          card.className = 'card h-100 ' + statusClass;
          card.innerHTML = `
            <div class="card-img-top-container">
              <div class="card-img-loading-placeholder">
                <div class="spinner-border spinner-border-sm" role="status">
                  <span class="visually-hidden">Carregando...</span>
                </div>
              </div>
              <img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" 
                data-src="${imageUrl}" class="card-img-top" alt="${evento.oque}" loading="lazy">
              ${isPast ? '<div class="past-badge">Evento Passado</div>' : ''}
            </div>
            <div class="card-body">
              <h5 class="card-title">${evento.oque}</h5>
              <p class="card-text">
                <i class="far fa-calendar-alt"></i> ${formattedDate}<br>
                <i class="fas fa-map-marker-alt"></i> ${evento.local}, ${evento.onde}
                ${evento.endereco ? `<br><small>${evento.endereco}</small>` : ''}
              </p>
              <div class="d-flex justify-content-between align-items-center">
                ${evento.preco 
                  ? `<span class="badge bg-success">R$ ${evento.preco}</span>` 
                  : '<span class="badge bg-info">Gratuito ou não informado</span>'}
                <span class="badge bg-secondary">${evento.tipo || 'Não categorizado'}</span>
              </div>
            </div>
            <div class="card-footer">
              <small class="text-muted">Fonte: ${evento.fonte}</small>
              ${evento.id 
                ? `<button class="btn btn-sm btn-outline-primary float-end edit-btn" data-id="${evento.id}">
                    <i class="fas fa-edit"></i>
                   </button>` 
                : ''}
            </div>
          `;
          
          col.appendChild(card);
          container.appendChild(col);
          
          // Carregar a imagem com lazy loading
          const imgElement = card.querySelector('img.card-img-top');
          const loadingPlaceholder = card.querySelector('.card-img-loading-placeholder');
          
          // Iniciar carregamento da imagem
          preloadImage(imageUrl)
            .then(() => {
              // Quando a imagem carregar, exibi-la e remover o placeholder
              imgElement.src = imageUrl;
              imgElement.onload = () => {
                if (loadingPlaceholder) {
                  loadingPlaceholder.style.display = 'none';
                }
              };
            })
            .catch(() => {
              // Em caso de erro, mostrar placeholder de erro
              loadingPlaceholder.innerHTML = '<div class="img-error"><i class="fas fa-image"></i></div>';
            });
        });
      }
      
      // Função para exibir os eventos no DOM - para manter compatibilidade
      function displayEventos(eventos) {
        // Esta função é mantida para compatibilidade com o código existente
        const container = document.getElementById('eventos-container');
        if (!container) return; // Evitar erros se o container foi removido
        
        container.innerHTML = '';
        
        // Se não há eventos, mostrar mensagem
        if (eventos.length === 0) {
          return;
        }
        
        // Criar cards para cada evento
        filteredEventos.forEach(evento => {
          const card = document.createElement('div');
          card.className = 'col-md-4 mb-4';
          
          // Formatar data para exibição
          const eventDate = parseDateString(evento.quando);
          const formattedDate = new Intl.DateTimeFormat('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          }).format(eventDate);
          
          // Determinar se é um evento passado
          const isPast = eventDate < new Date();
          
          // Definir classe com base no status do evento
          let statusClass = isPast ? 'past-event' : 'upcoming-event';
          
          // Construir a URL da imagem - sempre assumimos que há uma imagem
          const imageUrl = `https://mtcporto.pythonanywhere.com/eventos/default/imagem/${evento.imagem}`;
          
          // Criar o conteúdo do card com placeholder para imagem
          card.innerHTML = `
            <div class="card h-100 ${statusClass}">
              <div class="card-img-top-container">
                <div class="card-img-loading-placeholder">
                  <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Carregando...</span>
                  </div>
                </div>
                <img src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==" 
                  data-src="${imageUrl}" class="card-img-top" alt="${evento.oque}" loading="lazy">
                ${isPast ? '<div class="past-badge">Evento Passado</div>' : ''}
              </div>
              <div class="card-body">
                <h5 class="card-title">${evento.oque}</h5>
                <p class="card-text">
                  <i class="far fa-calendar-alt"></i> ${formattedDate}<br>
                  <i class="fas fa-map-marker-alt"></i> ${evento.local}, ${evento.onde}
                  ${evento.endereco ? `<br><small>${evento.endereco}</small>` : ''}
                </p>
                <div class="d-flex justify-content-between align-items-center">
                  ${evento.preco 
                    ? `<span class="badge bg-success">R$ ${evento.preco}</span>` 
                    : '<span class="badge bg-info">Gratuito ou não informado</span>'}
                  <span class="badge bg-secondary">${evento.tipo || 'Não categorizado'}</span>
                </div>
              </div>
              <div class="card-footer">
                <small class="text-muted">Fonte: ${evento.fonte}</small>
                ${evento.id 
                  ? `<button class="btn btn-sm btn-outline-primary float-end edit-btn" data-id="${evento.id}">
                      <i class="fas fa-edit"></i>
                     </button>` 
                  : ''}
              </div>
            </div>
          `;
          
          container.appendChild(card);
          
          // Carregar a imagem com lazy loading
          const imgElement = card.querySelector('img.card-img-top');
          const loadingPlaceholder = card.querySelector('.card-img-loading-placeholder');
          
          // Iniciar carregamento da imagem
          preloadImage(imageUrl)
            .then(() => {
              // Quando a imagem carregar, exibi-la e remover o placeholder
              imgElement.src = imageUrl;
              imgElement.onload = () => {
                if (loadingPlaceholder) {
                  loadingPlaceholder.style.display = 'none';
                }
              };
            })
            .catch(() => {
              // Em caso de erro, mostrar placeholder de erro
              loadingPlaceholder.innerHTML = '<div class="img-error"><i class="fas fa-image"></i></div>';
            });
        });
        
        // Adicionar event listeners aos botões de edição
        document.querySelectorAll('.edit-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            editEvento(id);
          });
        });
      }
      
      // Função auxiliar para converter string de data para objeto Date
      function parseDateString(dateStr) {
        if (!dateStr) return new Date(); // Data atual se nenhuma for fornecida
        
        // Formato esperado: "DD/MM/YYYY HH:MM"
        const parts = dateStr.split(' ');
        if (parts.length !== 2) return new Date(); // Formato inválido
        
        const dateParts = parts[0].split('/');
        const timeParts = parts[1].split(':');
        
        if (dateParts.length !== 3 || timeParts.length !== 2) return new Date(); // Formato inválido
        
        const day = parseInt(dateParts[0], 10);
        const month = parseInt(dateParts[1], 10) - 1; // Meses em JS são 0-indexed
        const year = parseInt(dateParts[2], 10);
        const hour = parseInt(timeParts[0], 10);
        const minute = parseInt(timeParts[1], 10);
        
        return new Date(year, month, day, hour, minute);
      }
      
      // Configurar os eventos para os filtros dropdown
      document.getElementById('filterLocal').addEventListener('change', function() {
        aplicarFiltros();
      });
      
      document.getElementById('filterFonte').addEventListener('change', function() {
        aplicarFiltros();
      });
      
      document.getElementById('searchQuery').addEventListener('input', function() {
        aplicarFiltros();
      });
      
      // Restante do código...
      // Modal e formulário de eventos
      const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
      const eventForm = document.getElementById('eventForm');
      const formError = document.getElementById('formError');
      let isEditing = false;
      let currentImageFile = null;
      
      // Configurar upload de imagens
      document.getElementById('uploadImageBtn').addEventListener('click', function() {
        document.getElementById('eventImage').click();
      });
      
      document.getElementById('eventImage').addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
          const file = e.target.files[0];
          currentImageFile = file;
          
          // Verificar tamanho da imagem (limite de 3MB)
          if (file.size > 3 * 1024 * 1024) {
            alert('A imagem não pode ter mais de 3MB.');
            e.target.value = '';
            return;
          }
          
          const reader = new FileReader();
          reader.onload = function(e) {
            document.getElementById('imagePreview').src = e.target.result;
            document.getElementById('imagePreview').style.display = 'block';
            document.getElementById('noImageIcon').style.display = 'none';
            document.getElementById('removeImageBtn').style.display = 'inline-block';
          };
          reader.readAsDataURL(file);
        }
      });
      
      document.getElementById('removeImageBtn').addEventListener('click', function() {
        document.getElementById('eventImage').value = '';
        document.getElementById('imagePreview').src = '';
        document.getElementById('imagePreview').style.display = 'none';
        document.getElementById('noImageIcon').style.display = 'block';
        document.getElementById('removeImageBtn').style.display = 'none';
        document.getElementById('imageUrl').value = '';
        currentImageFile = null;
      });
      
      // Abrir modal para novo evento
      document.getElementById('btnAddEvent').addEventListener('click', function() {
        resetForm();
        document.getElementById('eventModalLabel').textContent = 'Novo Evento';
        isEditing = false;
        eventModal.show();
      });
      
      // Editar evento existente
      function editEvento(id) {
        const evento = eventos.find(e => e.id == id);
        if (!evento) return;
        
        isEditing = true;
        document.getElementById('eventModalLabel').textContent = 'Editar Evento';
        
        // Preencher o formulário
        document.getElementById('eventId').value = evento.id;
        document.getElementById('eventTitle').value = evento.oque;
        
        const date = new Date(evento.quando);
        document.getElementById('eventDate').value = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        
        document.getElementById('eventPlace').value = evento.onde;
        document.getElementById('eventLocation').value = evento.local;
        document.getElementById('eventSource').value = evento.fonte;
        document.getElementById('eventPrice').value = evento.preco || '';
        document.getElementById('eventType').value = evento.tipo || '';
        
        // Exibir imagem se existir
        if (evento.imagem) {
          document.getElementById('imageUrl').value = evento.imagem;
          document.getElementById('imagePreview').src = evento.imagem;
          document.getElementById('imagePreview').style.display = 'block';
          document.getElementById('noImageIcon').style.display = 'none';
          document.getElementById('removeImageBtn').style.display = 'inline-block';
        } else {
          document.getElementById('imagePreview').style.display = 'none';
          document.getElementById('noImageIcon').style.display = 'block';
          document.getElementById('removeImageBtn').style.display = 'none';
        }
        
        eventModal.show();
      }
      
      // Salvar evento (criar ou atualizar)
      document.getElementById('saveEventBtn').addEventListener('click', async function() {
        if (!eventForm.checkValidity()) {
          eventForm.reportValidity();
          return;
        }
        
        formError.style.display = 'none';
        
        try {
          // Preparar dados do evento
          const eventData = {
            oque: document.getElementById('eventTitle').value,
            onde: document.getElementById('eventPlace').value,
            local: document.getElementById('eventLocation').value,
            fonte: document.getElementById('eventSource').value,
            preco: document.getElementById('eventPrice').value || null,
            tipo: document.getElementById('eventType').value || null
          };
          
          // Processar data
          const dateStr = document.getElementById('eventDate').value;
          const dateParts = dateStr.split(' ')[0].split('/');
          const timeParts = dateStr.split(' ')[1].split(':');
          
          const quando = new Date(
            parseInt(dateParts[2]), // ano
            parseInt(dateParts[1]) - 1, // mês (0-11)
            parseInt(dateParts[0]), // dia
            parseInt(timeParts[0]), // hora
            parseInt(timeParts[1])  // minutos
          );
          
          eventData.quando = quando.toISOString();
          
          // Processar imagem se houver uma nova
          if (currentImageFile) {
            const formData = new FormData();
            formData.append('imagem', currentImageFile);
            
            const imageResponse = await fetch('/upload_imagem', {
              method: 'POST',
              body: formData
            });
            
            if (!imageResponse.ok) {
              throw new Error('Falha ao enviar imagem');
            }
            
            const imageData = await imageResponse.json();
            eventData.imagem = imageData.url;
          } else if (document.getElementById('imageUrl').value) {
            // Manter a imagem existente se não foi alterada
            eventData.imagem = document.getElementById('imageUrl').value;
          }
          
          // ID para edição
          const eventId = document.getElementById('eventId').value;
          
          const url = isEditing ? `/eventos/${eventId}` : '/eventos';
          const method = isEditing ? 'PUT' : 'POST';
          
          const response = await fetch(url, {
            method: method,
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(eventData)
          });
          
          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Erro ao salvar evento');
          }
          
          // Fechar modal e atualizar lista
          eventModal.hide();
          fetchEventos();
          
        } catch (error) {
          formError.textContent = error.message;
          formError.style.display = 'block';
        }
      });
      
      // Excluir evento
      function deleteEvent(id) {
        if (confirm('Tem certeza que deseja excluir este evento?')) {
          fetch(`/eventos/${id}`, {
            method: 'DELETE'
          })
          .then(response => {
            if (response.ok) {
              fetchEventos();
            } else {
              alert('Erro ao excluir evento');
            }
          })
          .catch(error => console.error('Erro:', error));
        }
      }
      
      // Resetar formulário
      function resetForm() {
        eventForm.reset();
        document.getElementById('eventId').value = '';
        document.getElementById('imageUrl').value = '';
        document.getElementById('imagePreview').src = '';
        document.getElementById('imagePreview').style.display = 'none';
        document.getElementById('noImageIcon').style.display = 'block';
        document.getElementById('removeImageBtn').style.display = 'none';
        currentImageFile = null;
        formError.style.display = 'none';
      }
      
      // Buscar eventos ao carregar a página
      fetchEventos();
      
      // Adicionar event listeners para os botões do rodapé
      document.getElementById('clearCacheBtn').addEventListener('click', function() {
        localStorage.removeItem('eventos_cache');
        localStorage.removeItem('eventos_cache_timestamp');
        imageCache.clear();
        alert('Cache limpo com sucesso!');
        fetchEventos(true);
      });
      
      document.getElementById('refreshBtn').addEventListener('click', function() {
        fetchEventos(true);
      });
    });
  </script>
</body>
</html>